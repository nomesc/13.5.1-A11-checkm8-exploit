#include <mach-o/loader.h>
#include <stdio.h>
#include <stdint.h>
#include <stdlib.h>
#include <string.h>
#include <sys/fcntl.h>
#include <sys/mman.h>
#include <sys/stat.h>
#include <unistd.h>

void terminate(char *mesaj)
{
    puts(mesaj);
    exit(-1);
}

int main(int argc, char **argv)
{
    uint32_t i, j;
    struct section_64 *section;
    struct mach_header_64 header;
    uint8_t *file;
    struct stat info;
    struct segment_command_64 *command;
    int fd, output;
    if (argc != 3)
        terminate("Usage:\nmacho_text macho_file output");
    fd = open(argv[1], O_RDONLY);
    if (fd == -1)
    {
        terminate("Can't open input file");
    }
    output = open(argv[2], O_WRONLY | O_TRUNC | O_CREAT, S_IRWXU | S_IRWXG | S_IRWXO);
    if (output == -1)
    {
        close(fd);
        terminate("Can't open output file");
    }
    fstat(fd, &info);
    file = mmap(NULL, info.st_size, PROT_READ, MAP_PRIVATE, fd, 0);
    if (file == MAP_FAILED)
    {
        close(fd);
        close(output);
        terminate("Failed to mmap");
    }
    header = *(struct mach_header_64 *)file;
    if (header.magic != MH_MAGIC_64)
    {
        close(fd);
        close(output);
        munmap(file, info.st_size);
        terminate("fisierul nu este mach-o");
    }
    command = (struct segment_command_64 *)(file + sizeof(struct mach_header_64));
    puts("[*] Parsing segments...");
    for (i = 0; i < header.ncmds; i++)
    {
        //printf("%s\n", command->segname);
        if (strncmp("__TEXT", command->segname, 6) != 0)
        {
            command = (struct segment_command_64 *)((uint8_t *)command + command->cmdsize);
            continue;
        }
        puts("[*] Found __TEXT segment");
        printf("\t[.] offset in file %llx\n", command->fileoff);
        printf("\t[.] size           %llx\n", command->filesize);
        section = (struct section_64 *)(command + 1);
        puts("[*] Parsing sections...");
        for (j = 0; j < command->nsects; j++)
        {
            //printf("%s\n", section->sectname);
            if (strncmp("__text", section->sectname, 6) != 0)
            {
                section += 1;
                continue;
            }
            puts("[*] Found __text section");
            printf("\t[.] offset in file %x\n", section->offset);
            printf("\t[.] size           %llx\n", section->size);
            write(output, file + section->offset, section->size);
            close(fd);
            close(output);
            munmap(file, info.st_size);
            puts("[*] Done!");
            return 0;
        }
    }
    puts("[!] TEXT not found");
    close(fd);
    close(output);
    munmap(file, info.st_size);
    return -1;
}
