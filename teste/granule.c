#include <stdio.h>
#include <stdint.h>
#include <stdbool.h>

typedef struct
{
    uint64_t offset;
    uint64_t value;
} memory_map;

memory_map get_mapping(uint64_t virtual_address, bool write, bool execute)
{
    memory_map ret = {0};
    uint64_t level_shift = 25;
    ret.offset = (virtual_address >> level_shift) * 8;
    uint64_t flags = 0;
    if (!execute)
        flags |= 0x60000000000000;
    if (!write)
        flags |= 0x80;
    flags |= 0x421 | 0x200 | 4;
    ret.value = virtual_address | flags;
    return ret;
}

int main()
{
	//printf("%x\n", 1<<0xE);
	uint64_t x = (0x4000) * 0x400;
	uint64_t entry = 0x1000006A5;
	uint64_t mask = 0xfffffffff000;
	//printf("x is \t\t\t0x%llx\n", x);
	//printf("memory from entry \t0x%llx\n", entry&mask);

	uint64_t level = 2;
	uint64_t vaddr = 0x181ffffff + 1;//0x100000000;
	uint64_t level_shift = (level * -0xb) + 0x2f;
	uint64_t level_entries = 1 << (0xE - 3);
	uint64_t index = (vaddr >> level_shift); //& (level_entries - 1);
	printf("level_entries is %llx\n", level_entries);
	printf("mapping \t%llx\n", vaddr);
	printf("index = \t0x%llx\n", index*8);
	printf("level_shift = \t0x%llx\n", level_shift);
	uint64_t ent = 0x200 | vaddr;
	printf("entry is \t%llx\n", ent);
	printf("leevel size is %x\n", 1<<level_shift);

	puts("------------");
	printf("x is	  0x%llx\n", x);
	printf("addres is 0x%llx\n", 0x1ffffffff & mask);

	puts("------------");
	printf("rwx value   : 0x%llx\n", get_mapping(vaddr, true, true).value);
	printf("entry offset: 0x%llx\n", get_mapping(vaddr, true, true).offset);

	return 0;
}
