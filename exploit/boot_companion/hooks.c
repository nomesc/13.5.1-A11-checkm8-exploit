#include <stdint.h>
#include "./utils/utils.h"

extern void kernel_patcher(uint8_t *darwin, boot_args *args);
extern void iBoot_patcher(uint8_t *iBoot, uint8_t *args);

extern uint64_t stage;

/*void keep_rwx(uint64_t *ttbr0)
{
    //uint64_t start = 0x180000000;
    //uint64_t end = 0x872000000;
    // Vom mapa tot intre aceste adrese ca RWX.
    // Asta include shellcode-ul nostru si trambulina iBoot-ului pe care
    // trebuie sa o modificam pentru a ne continua executia pana in userland
    //uint64_t entry_length = 0x2000000;
    //uint64_t current = start;
    *(uint64_t *)((uint8_t *)ttbr0 + 0x600) = start | 0x625;

    while (current < end + 1)
    {
        *ttbr0 = current | 0x625;
        ttbr0 += 1;
        current += entry_length;
    }
}*/

void boot_patcher(uint8_t *next_stage, uint8_t *args)
{
    if (stage == 0x1234)
    {
        // Suntem chemati din iBoot
        kernel_patcher(next_stage, (boot_args *)args);
    }
    else if (stage == 0xABCD)
    {
        // Suntem chemati din SecureROM
        stage = 0x1234;
        iBoot_patcher(next_stage, args);
    }
}
