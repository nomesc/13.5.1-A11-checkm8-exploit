#include "utils.h"

extern void write_ttbr0();
extern void write_ttbr0_hook();

extern void write_sctlr();
extern void write_sctlr_hook();

extern void trampoline_start();
extern void trampoline_start_hook();

// Am fost chemati din trambulina SecureROM-ului.
// Vrem sa modificam iBoot-ul inainte sa incepem sa il executam
// pentru a ne putea continua executia in urmatorul stadiu.
void iBoot_patcher(uint8_t *iBoot, uint8_t *args)
{
    /*uint32_t patch = 0x9100C484;
    uint64_t address = 0x180031E14ULL;
    instruction_patch verbose;
    verbose.address = (uint32_t *)address;
    verbose.patch = &patch;
    verbose.number_of_instructions = 1;
    apply_pathches(&verbose, 1);*/

    instruction_patch iBoot_hooks[4];
    int32_t ret;
    uint64_t companion_pointer = 0x1801E4000;
    uint64_t replace = 0x180000000;

    iBoot_hooks[0].address = 0;
    iBoot_hooks[0].function = (uint32_t *)&companion_pointer;
    iBoot_hooks[0].patch = (uint32_t *)&replace;
    iBoot_hooks[0].number_of_instructions = 2;

    iBoot_hooks[1].address = 0;
    iBoot_hooks[1].function = (uint32_t *)&write_ttbr0;
    iBoot_hooks[1].patch = (uint32_t *)&write_ttbr0_hook;
    iBoot_hooks[1].number_of_instructions = 3;

    iBoot_hooks[2].address = 0;
    iBoot_hooks[2].function = (uint32_t *)&write_sctlr;
    iBoot_hooks[2].patch = (uint32_t *)&write_sctlr_hook;
    iBoot_hooks[2].number_of_instructions = 5;

    iBoot_hooks[3].address = 0;
    iBoot_hooks[3].function = (uint32_t *)&trampoline_start;
    iBoot_hooks[3].patch = (uint32_t *)&trampoline_start_hook;
    iBoot_hooks[3].number_of_instructions = 3;

    ret = patch_finder((uint32_t *)iBoot, iBoot_hooks, 4);
    if (ret != 0)
    {
        while (1 != 0)
            ;
    }
    apply_pathches(iBoot_hooks, 4);
}